<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"   "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.cyou.library.xh.recommand.dao.RecommandDao">

	<resultMap type="Recommand" id="recommandMap">
		<id property="recId" column="rec_id"/>
		<result property="bookName" column="book_name"/>
		<result property="bookPublish" column="book_publish"/>
		<result property="bookPrice" column="book_price"/>
		<result property="bookDouban" column="book_douban"/>
		<result property="bookAuthor" column="book_author"/>
		<result property="recFlag" column="rec_flag"/>
		<result property="recDate" column="rec_date"/>
		<result property="recUrl" column="rec_url"/>
		<association property="user" column="user_id"  select="getUserByUserId"/>
		<association property="type" column="type_id" select="getTypeById"/>
	</resultMap>
	
	<resultMap type="User" id="userMap">
		<id property="user_id" column="user_id"/>
		<result property="user_num" column="user_num"/>
		<result property="user_password" column="user_password"/>
		<result property="user_mail" column="user_mail" /> 
		<result property="user_realname" column="user_realname"/>
		<result property="user_department" column="user_department"/>
		<result property="user_borrownum" column="user_borrownum"/>
	</resultMap>
	
	<resultMap type="BookType" id="typeMap">
			<id property="typeId" column="type_id"/>
			<result property="typeName" column="type_name"/>
			<result property="fatherTypeId" column="type_fathertypeid"/>
	</resultMap>
	
	<sql id="selectColumn">
		select rec_id,user_id,book_name,book_author,book_publish,book_price,book_douban,type_id,rec_date,rec_url,rec_flag from t_recommend
	</sql>
	
	<select id="getUserByUserId" parameterType="User" resultMap="userMap">
		select user_id,user_num,user_password,user_mail,user_realname,user_department,user_borrownum  from t_user where user_id = #{user_id};
	</select>
	
	<select id="getTypeById" resultMap="typeMap">
		select type_id,type_name,type_fathertypeid from t_booktype where type_id=#{type_id}
	</select>
	
	<insert id="addRecommand" parameterType="Recommand">
		insert into t_recommend(user_id,book_name,book_author,book_publish,book_price,book_douban,rec_date,type_id,rec_url) 
				values(#{user.user_id},#{bookName},#{bookAuthor},#{bookPublish},#{bookPrice},#{bookDouban},#{recDate},#{type.typeId},#{recUrl})
	</insert>
	
	<update id="updateRecommand" parameterType="Recommand">
		update t_recommend
			set
			<!--<set>-->
				<!-- <if test="book_name!=''"> -->book_name=#{bookName},	<!--</if>-->
				<!--<if test="book_author!=''">-->book_author=#{bookAuthor},<!--</if>-->
				<!--<if test="book_publish!=''">-->book_publish=#{bookPublish},<!--</if>-->
				<!--<if test="book_douban!=''">-->book_douban=#{bookDouban},<!--</if>-->
				<!--<if test="type_id!=0">-->type_id=#{type.typeId},<!--</if>-->
				<!--<if test="rec_url!=''">-->rec_url=#{recUrl},<!--</if>-->
				book_price=#{bookPrice}
			<!--</set>-->
		 where rec_id= #{recId}
	</update>
	
	<update id="updateProcedure" parameterType="java.util.Map">
		update t_recommend set rec_flag = #{state} where 
		rec_id in
		<foreach collection="list" item="list"  open="(" separator="," close=")">
			 #{list}
		</foreach>
	</update>
	
	<select id="getRecommandById" resultMap="recommandMap" parameterType="java.lang.Integer">
		<include refid="selectColumn"/> where rec_id = #{recId}
	</select>
	
	<select id="getRecommandLists" resultMap="recommandMap" parameterType="list">
		<include refid="selectColumn"/> 
			where rec_id in
		<foreach collection="list" item="id" open="(" separator="," close=")">
			#{id}
		</foreach>
	</select>
	
	<select id="getAllRecommadList" resultMap="recommandMap">
		<include refid="selectColumn"/>
	</select>
	
	<select id="getRecommandPageList" resultMap="recommandMap" parameterType="java.util.Map">
		<include refid="selectColumn"/> where rec_flag = #{recFlag}
			limit #{pageIndex},#{pageSize} 
	</select>
	
	<select id="getAllCounts" resultType="Integer">
		select count(*) from t_recommend where rec_flag = #{recFlag}
	</select>
	
	<select id="personRecommandPageList" resultMap="recommandMap" parameterType="java.util.Map">
		<include refid="selectColumn"/>
			limit #{pageIndex},#{pageSize} 
	</select>
	
	<select id="personRecommandCount" resultType="Integer">
		select count(*) from t_recommend
	</select>
	
	<delete id="deleteRecommand" parameterType="java.lang.Integer">
		delete from t_recommend
		where rec_id = #{recId}
	</delete>
	
	<select id="checkBookName" resultType="java.lang.String" parameterType="java.lang.String">
			select book_name from t_recommend where book_name=#{bookName} 
			union  
			select book_name from t_book where book_name=#{bookName}
	</select>
	
	<select id="recommandListByState" resultMap="recommandMap" parameterType="java.lang.Integer">
		<include refid="selectColumn"/> 
		where rec_flag = #{state}
	</select>
	
</mapper>